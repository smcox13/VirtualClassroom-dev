{"ast":null,"code":"/**!\n * lib/keyobject.js -- KMS Key Representation\n *\n * Copyright (c) 2015 Cisco Systems, Inc. See LICENSE file.\n */\n\"use strict\";\n\nvar jose = require(\"node-jose\"),\n    uuid = require(\"uuid\");\n\nvar KMS = {\n  KeyObject: require(\"./keyobject\")\n};\n\nfunction KMSContext() {\n  var sharedKey = null,\n      clientInfo = {},\n      serverInfo = {};\n  Object.defineProperty(this, \"ephemeralKey\", {\n    get: function () {\n      // TODO: honor expiration\n      return sharedKey;\n    },\n    set: function (key) {\n      sharedKey = key ? KMS.KeyObject.fromObject(key) : null;\n    },\n    enumerable: true\n  });\n  Object.defineProperty(this, \"clientInfo\", {\n    get: function () {\n      return clientInfo;\n    },\n    set: function (info) {\n      // TODO: validate client info\n      clientInfo = info || {};\n    },\n    enumerable: true\n  });\n  Object.defineProperty(this, \"serverInfo\", {\n    get: function () {\n      return serverInfo;\n    },\n    set: function (info) {\n      // TODO: validate server info\n      serverInfo = info || {};\n    },\n    enumerable: true\n  });\n  Object.defineProperty(this, \"requestId\", {\n    value: function () {\n      return uuid();\n    }\n  });\n}\n\nKMSContext.prototype.createECDHKey = function () {\n  var clientInfo = this.clientInfo;\n  var ks = jose.JWK.createKeyStore(); // TODO: make this more configurable\n\n  var keyType = \"EC\",\n      keyOrder = \"P-256\",\n      expiresIn = 3600000;\n  var promise = ks.generate(keyType, keyOrder);\n  promise = promise.then(function (k) {\n    var ts = new Date();\n    var rep = {\n      uri: \"-internal/\" + k.kid,\n      jwk: k.toJSON(true),\n      userId: clientInfo && clientInfo.credential && clientInfo.credential.userId || \"\",\n      clientId: clientInfo && clientInfo.clientId || \"\",\n      createDate: ts,\n      expirationDate: new Date(ts.getTime() + expiresIn)\n    };\n    return new KMS.KeyObject(rep);\n  });\n  return promise;\n};\n\nKMSContext.prototype.deriveEphemeralKey = function (remote) {\n  var local = this.ephemeralKey;\n\n  if (!local || !local.jwk || \"EC\" !== local.jwk.kty) {\n    return Promise.reject(new Error(\"invalid local ECDH key\"));\n  }\n\n  remote = KMS.KeyObject.fromObject(remote);\n  var promise;\n  promise = Promise.all([local.asKey(), remote.asKey()]);\n  promise = promise.then(function (keys) {\n    var lkey = keys[0],\n        rkey = keys[1];\n    var props = {\n      public: rkey.toObject()\n    };\n    var k = lkey.toObject(true);\n    return jose.JWA.derive(\"ECDH-HKDF\", k, props);\n  });\n  promise = promise.then(function (result) {\n    var uri = remote.uri,\n        created = remote.createDate,\n        expires = remote.expirationDate;\n    var shared = {\n      uri: uri,\n      createDate: created,\n      expirationDate: expires,\n      jwk: {\n        kty: \"oct\",\n        kid: uri,\n        alg: \"A256GCM\",\n        k: jose.util.base64url.encode(result)\n      }\n    };\n    return new KMS.KeyObject(shared);\n  });\n  return promise;\n};\n\nmodule.exports = KMSContext;","map":{"version":3,"sources":["/Users/pratison/Work/Cisco/Education/React/education-webex/node_modules/node-kms/lib/context.js"],"names":["jose","require","uuid","KMS","KeyObject","KMSContext","sharedKey","clientInfo","serverInfo","Object","defineProperty","get","set","key","fromObject","enumerable","info","value","prototype","createECDHKey","ks","JWK","createKeyStore","keyType","keyOrder","expiresIn","promise","generate","then","k","ts","Date","rep","uri","kid","jwk","toJSON","userId","credential","clientId","createDate","expirationDate","getTime","deriveEphemeralKey","remote","local","ephemeralKey","kty","Promise","reject","Error","all","asKey","keys","lkey","rkey","props","public","toObject","JWA","derive","result","created","expires","shared","alg","util","base64url","encode","module","exports"],"mappings":"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","sourcesContent":["/**!\n * lib/keyobject.js -- KMS Key Representation\n *\n * Copyright (c) 2015 Cisco Systems, Inc. See LICENSE file.\n */\n \"use strict\";\n\nvar jose = require(\"node-jose\"),\n    uuid = require(\"uuid\");\n\nvar KMS = {\n  KeyObject: require(\"./keyobject\")\n};\n\nfunction KMSContext() {\n  var sharedKey = null,\n      clientInfo = {},\n      serverInfo = {};\n\n  Object.defineProperty(this, \"ephemeralKey\", {\n    get: function() {\n      // TODO: honor expiration\n      return sharedKey;\n    },\n    set: function(key) {\n      sharedKey = key ?\n                  KMS.KeyObject.fromObject(key) :\n                  null;\n    },\n    enumerable: true\n  });\n  Object.defineProperty(this, \"clientInfo\", {\n    get: function() { return clientInfo; },\n    set: function(info) {\n      // TODO: validate client info\n      clientInfo = info || {};\n    },\n    enumerable: true\n  });\n  Object.defineProperty(this, \"serverInfo\", {\n    get: function() { return serverInfo; },\n    set: function(info) {\n      // TODO: validate server info\n      serverInfo = info || {};\n    },\n    enumerable: true\n  });\n\n  Object.defineProperty(this, \"requestId\", {\n    value: function() {\n      return uuid();\n    }\n  });\n}\n\nKMSContext.prototype.createECDHKey = function() {\n  var clientInfo = this.clientInfo;\n  var ks = jose.JWK.createKeyStore();\n\n  // TODO: make this more configurable\n  var keyType = \"EC\",\n      keyOrder = \"P-256\",\n      expiresIn = 3600000;\n  var promise = ks.generate(keyType, keyOrder);\n  promise = promise.then(function(k) {\n    var ts = new Date();\n    var rep = {\n     uri: \"-internal/\" + k.kid,\n     jwk: k.toJSON(true),\n     userId: (clientInfo && clientInfo.credential && clientInfo.credential.userId) ||\n             \"\",\n     clientId: (clientInfo && clientInfo.clientId) ||\n               \"\",\n     createDate: ts,\n     expirationDate: new Date(ts.getTime() + expiresIn)\n    };\n\n    return new KMS.KeyObject(rep);\n  });\n  return promise;\n};\n\nKMSContext.prototype.deriveEphemeralKey = function(remote) {\n  var local = this.ephemeralKey;\n  if (!local || !local.jwk || \"EC\" !== local.jwk.kty) {\n    return Promise.reject(new Error(\"invalid local ECDH key\"));\n  }\n  remote = KMS.KeyObject.fromObject(remote);\n\n  var promise;\n  promise = Promise.all([local.asKey(), remote.asKey()]);\n  promise = promise.then(function(keys) {\n    var lkey = keys[0],\n        rkey = keys[1];\n    var props = {\n      public: rkey.toObject()\n    };\n    var k = lkey.toObject(true);\n    return jose.JWA.derive(\"ECDH-HKDF\", k, props);\n  });\n  promise = promise.then(function(result) {\n    var uri = remote.uri,\n        created = remote.createDate,\n        expires = remote.expirationDate;\n    var shared = {\n      uri: uri,\n      createDate: created,\n      expirationDate: expires,\n      jwk: {\n        kty: \"oct\",\n        kid: uri,\n        alg: \"A256GCM\",\n        k: jose.util.base64url.encode(result)\n      }\n    };\n    return new KMS.KeyObject(shared);\n  });\n  return promise;\n};\n\nmodule.exports = KMSContext;\n"]},"metadata":{},"sourceType":"script"}