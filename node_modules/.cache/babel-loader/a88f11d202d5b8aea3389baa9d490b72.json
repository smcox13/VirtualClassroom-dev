{"ast":null,"code":"'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar _typeof2 = require('babel-runtime/helpers/typeof');\n\nvar _typeof3 = _interopRequireDefault(_typeof2);\n\nvar _promise = require('babel-runtime/core-js/promise');\n\nvar _promise2 = _interopRequireDefault(_promise);\n\nvar _apply = require('babel-runtime/core-js/reflect/apply');\n\nvar _apply2 = _interopRequireDefault(_apply);\n\nvar _map = require('babel-runtime/core-js/map');\n\nvar _map2 = _interopRequireDefault(_map);\n\nvar _weakMap = require('babel-runtime/core-js/weak-map');\n\nvar _weakMap2 = _interopRequireDefault(_weakMap);\n\nvar _wrap2 = require('lodash/wrap');\n\nvar _wrap3 = _interopRequireDefault(_wrap2);\n\nexports.default = oneFlight;\n\nvar _templateContainer = require('./template-container');\n\nvar _templateContainer2 = _interopRequireDefault(_templateContainer);\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n} // Alias Map and WeakMap to get around a babel compiler bug\n\n\nvar W = _weakMap2.default;\n/*!\n * Copyright (c) 2015-2019 Cisco Systems, Inc. See LICENSE file.\n */\n\nvar M = _map2.default;\nvar WeakMappedMappedMap = (0, _templateContainer2.default)(W, M, M);\nvar flights = new WeakMappedMappedMap();\n/**\n * @memberof Util\n * @param {Object} options\n * @param {Function} options.keyFactory\n * @param {boolean} options.cacheFailures\n * @param {boolean} options.cacheSuccesses\n * @returns {Function}\n */\n\nfunction oneFlight() {\n  for (var _len = arguments.length, params = Array(_len), _key = 0; _key < _len; _key++) {\n    params[_key] = arguments[_key];\n  }\n\n  if (params.length === 3) {\n    return (0, _apply2.default)(oneFlightDecorator, null, params);\n  }\n\n  var options = params[0] || {};\n  var cacheFailures = options.cacheFailures,\n      cacheSuccesses = options.cacheSuccesses,\n      keyFactory = options.keyFactory;\n  return oneFlightDecorator;\n  /**\n   * @param {Object} target\n   * @param {string} prop\n   * @param {Object} descriptor\n   * @private\n   * @returns {Object}\n   */\n\n  function oneFlightDecorator(target, prop, descriptor) {\n    var key = prop;\n    descriptor.value = (0, _wrap3.default)(descriptor.value, function oneFlightExecutor(fn) {\n      var _this = this;\n\n      var innerKey = key;\n\n      for (var _len2 = arguments.length, args = Array(_len2 > 1 ? _len2 - 1 : 0), _key2 = 1; _key2 < _len2; _key2++) {\n        args[_key2 - 1] = arguments[_key2];\n      }\n\n      if (keyFactory) {\n        innerKey = innerKey + '_' + keyFactory.apply(undefined, args);\n      }\n      /* eslint no-invalid-this: [0] */\n\n\n      var flight = flights.get(this, target, innerKey);\n\n      if (flight) {\n        return flight;\n      }\n\n      flight = (0, _apply2.default)(fn, this, args);\n\n      if (!cacheFailures && flight && flight.catch) {\n        flight = flight.catch(function (reason) {\n          flights.delete(_this, target, innerKey);\n          return _promise2.default.reject(reason);\n        });\n      }\n\n      if (!cacheSuccesses && flight && flight.then) {\n        flight = flight.then(function (result) {\n          flights.delete(_this, target, innerKey);\n          return result;\n        });\n      }\n\n      flights.set(this, target, innerKey, flight);\n      return flight;\n    }); // This *should* make decorators compatible with AmpersandState class\n    // definitions\n\n    if ((typeof target === 'undefined' ? 'undefined' : (0, _typeof3.default)(target)) === 'object' && !target.prototype) {\n      target[prop] = descriptor.value;\n    }\n\n    return descriptor;\n  }\n}","map":{"version":3,"sources":["one-flight.js"],"names":["W","M","WeakMappedMappedMap","flights","oneFlight","params","options","cacheFailures","cacheSuccesses","keyFactory","key","descriptor","args","innerKey","flight","target"],"mappings":"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","sourcesContent":["/*!\n * Copyright (c) 2015-2019 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport {wrap} from 'lodash';\nimport make from './template-container';\n\n// Alias Map and WeakMap to get around a babel compiler bug\nconst W = WeakMap;\nconst M = Map;\nconst WeakMappedMappedMap = make(W, M, M);\n\nconst flights = new WeakMappedMappedMap();\n\n/**\n * @memberof Util\n * @param {Object} options\n * @param {Function} options.keyFactory\n * @param {boolean} options.cacheFailures\n * @param {boolean} options.cacheSuccesses\n * @returns {Function}\n */\nexport default function oneFlight(...params) {\n  if (params.length === 3) {\n    return Reflect.apply(oneFlightDecorator, null, params);\n  }\n\n  const options = params[0] || {};\n\n  const {\n    cacheFailures,\n    cacheSuccesses,\n    keyFactory\n  } = options;\n\n  return oneFlightDecorator;\n\n  /**\n   * @param {Object} target\n   * @param {string} prop\n   * @param {Object} descriptor\n   * @private\n   * @returns {Object}\n   */\n  function oneFlightDecorator(target, prop, descriptor) {\n    const key = prop;\n\n    descriptor.value = wrap(descriptor.value, function oneFlightExecutor(fn, ...args) {\n      let innerKey = key;\n\n      if (keyFactory) {\n        innerKey = `${innerKey}_${keyFactory(...args)}`;\n      }\n\n      /* eslint no-invalid-this: [0] */\n      let flight = flights.get(this, target, innerKey);\n\n      if (flight) {\n        return flight;\n      }\n\n      flight = Reflect.apply(fn, this, args);\n      if (!cacheFailures && flight && flight.catch) {\n        flight = flight.catch((reason) => {\n          flights.delete(this, target, innerKey);\n\n          return Promise.reject(reason);\n        });\n      }\n\n      if (!cacheSuccesses && flight && flight.then) {\n        flight = flight.then((result) => {\n          flights.delete(this, target, innerKey);\n\n          return result;\n        });\n      }\n\n      flights.set(this, target, innerKey, flight);\n\n      return flight;\n    });\n\n    // This *should* make decorators compatible with AmpersandState class\n    // definitions\n    if (typeof target === 'object' && !target.prototype) {\n      target[prop] = descriptor.value;\n    }\n\n    return descriptor;\n  }\n}\n"]},"metadata":{},"sourceType":"script"}