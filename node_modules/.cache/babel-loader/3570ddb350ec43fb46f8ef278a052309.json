{"ast":null,"code":"/**!\n * lib/request.js -- KMS (Generic) Request\n *\n * Copyright (c) 2015 Cisco Systems, Inc. See LICENSE file.\n */\n\"use strict\";\n\nvar clone = require(\"lodash.clone\"),\n    jose = require(\"node-jose\");\n\nfunction KMSRequest(body) {\n  var wrapped = \"\";\n  body = body && clone(body) || {};\n  Object.defineProperty(this, \"wrapped\", {\n    get: function () {\n      return wrapped;\n    },\n    set: function (w) {\n      wrapped = String(w || \"\");\n    },\n    enumerable: true\n  });\n  Object.defineProperty(this, \"body\", {\n    get: function () {\n      return body;\n    },\n    set: function (b) {\n      b = b && clone(b) || {}; // carry forward requestId\n\n      if (\"requestId\" in body) {\n        b.requestId = body.requestId;\n      } // carry forward uri\n\n\n      if (\"uri\" in body) {\n        b.uri = body.uri;\n      } // carry forward method\n\n\n      if (\"method\" in body) {\n        b.method = body.method;\n      } // clear any wrapped, then save\n\n\n      wrapped = \"\";\n      body = b;\n    },\n    enumerable: true\n  });\n  Object.defineProperty(this, \"requestId\", {\n    get: function () {\n      return body.requestId || \"\";\n    },\n    set: function (id) {\n      if (!id) {\n        delete body.requestId;\n      } else {\n        body.requestId = id;\n      }\n    },\n    enumerable: true\n  });\n  Object.defineProperty(this, \"uri\", {\n    get: function () {\n      return body.uri || \"\";\n    },\n    set: function (uri) {\n      if (!uri) {\n        delete body.uri;\n      } else {\n        body.uri = uri;\n      }\n    },\n    enumerable: true\n  });\n  Object.defineProperty(this, \"method\", {\n    get: function () {\n      return body.method || \"\";\n    },\n    set: function (method) {\n      if (!method) {\n        delete body.method;\n      } else {\n        body.method = method;\n      }\n    },\n    enumerable: true\n  });\n}\n\nKMSRequest.prototype.wrap = function (ctx, opts) {\n  opts = opts || {}; // TODO: make this more configurable\n\n  var self = this,\n      promise; // set the requestId if not already set\n\n  if (!this.requestId || opts.requestId) {\n    this.requestId = opts.requestId || ctx.requestId();\n  }\n\n  var body = this.body;\n  body.client = ctx.clientInfo; // prepare the key\n\n  if (opts.serverKey) {\n    promise = jose.JWK.asKey(ctx.serverInfo.key);\n  } else {\n    promise = ctx.ephemeralKey.asKey();\n  }\n\n  promise = promise.then(function (jwk) {\n    var key = jwk;\n    var cfg = {\n      compact: true,\n      contentAlg: opts.contentAlg || \"A256GCM\"\n    };\n    var jwe = jose.JWE.createEncrypt(cfg, key);\n    return jwe.final(JSON.stringify(self.body), \"utf8\");\n  });\n  promise = promise.then(function (result) {\n    // save wrapped\n    self.wrapped = result;\n    return result;\n  });\n  return promise;\n};\n\nmodule.exports = KMSRequest;","map":{"version":3,"sources":["/Users/pratison/Work/Cisco/Education/React/education-webex/node_modules/node-kms/lib/request.js"],"names":["clone","require","jose","KMSRequest","body","wrapped","Object","defineProperty","get","set","w","String","enumerable","b","requestId","uri","method","id","prototype","wrap","ctx","opts","self","promise","client","clientInfo","serverKey","JWK","asKey","serverInfo","key","ephemeralKey","then","jwk","cfg","compact","contentAlg","jwe","JWE","createEncrypt","final","JSON","stringify","result","module","exports"],"mappings":"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","sourcesContent":["/**!\n * lib/request.js -- KMS (Generic) Request\n *\n * Copyright (c) 2015 Cisco Systems, Inc. See LICENSE file.\n */\n \"use strict\";\n\nvar clone = require(\"lodash.clone\"),\n    jose = require(\"node-jose\");\n\nfunction KMSRequest(body) {\n  var wrapped = \"\";\n  body = (body && clone(body)) || {};\n\n  Object.defineProperty(this, \"wrapped\", {\n    get: function() { return wrapped; },\n    set: function(w) { wrapped = String(w || \"\"); },\n    enumerable: true\n  });\n  Object.defineProperty(this, \"body\", {\n    get: function() { return body; },\n    set: function(b) {\n      b = (b && clone(b)) || {};\n\n      // carry forward requestId\n      if (\"requestId\" in body) {\n        b.requestId = body.requestId;\n      }\n      // carry forward uri\n      if (\"uri\" in body) {\n        b.uri = body.uri;\n      }\n      // carry forward method\n      if (\"method\" in body) {\n        b.method = body.method;\n      }\n      // clear any wrapped, then save\n      wrapped = \"\";\n      body = b;\n    },\n    enumerable: true\n  });\n\n  Object.defineProperty(this, \"requestId\", {\n    get: function() { return body.requestId || \"\"; },\n    set: function(id) {\n      if (!id) {\n        delete body.requestId;\n      } else {\n        body.requestId = id;\n      }\n    },\n    enumerable: true\n  });\n  Object.defineProperty(this, \"uri\", {\n    get: function() { return body.uri || \"\"; },\n    set: function(uri) {\n      if (!uri) {\n        delete body.uri;\n      } else {\n        body.uri = uri;\n      }\n    },\n    enumerable: true\n  });\n  Object.defineProperty(this, \"method\", {\n    get: function() { return body.method || \"\"; },\n    set: function(method) {\n      if (!method) {\n        delete body.method;\n      } else {\n        body.method = method;\n      }\n    },\n    enumerable: true\n  });\n}\n\nKMSRequest.prototype.wrap = function(ctx, opts) {\n  opts = opts || {};\n\n  // TODO: make this more configurable\n  var self = this,\n      promise;\n\n  // set the requestId if not already set\n  if (!this.requestId || opts.requestId) {\n    this.requestId = opts.requestId || ctx.requestId();\n  }\n\n  var body = this.body;\n  body.client = ctx.clientInfo;\n\n  // prepare the key\n  if (opts.serverKey) {\n    promise = jose.JWK.asKey(ctx.serverInfo.key);\n  } else {\n    promise = ctx.ephemeralKey.asKey();\n  }\n  promise = promise.then(function(jwk) {\n    var key = jwk;\n    var cfg = {\n      compact: true,\n      contentAlg: opts.contentAlg || \"A256GCM\"\n    };\n    var jwe = jose.JWE.createEncrypt(cfg, key);\n    return jwe.final(JSON.stringify(self.body), \"utf8\");\n  });\n  promise = promise.then(function(result) {\n    // save wrapped\n    self.wrapped = result;\n    return result;\n  });\n  return promise;\n};\n\nmodule.exports = KMSRequest;\n"]},"metadata":{},"sourceType":"script"}