{"ast":null,"code":"/*!\n * algorithms/aes-gcm.js - AES-GCM Encryption and Key-Wrapping\n *\n * Copyright (c) 2015 Cisco Systems, Inc.  See LICENSE file.\n */\n\"use strict\";\n\nvar helpers = require(\"./helpers.js\"),\n    CONSTANTS = require(\"./constants.js\"),\n    GCM = require(\"../deps/ciphermodes/gcm\");\n\nfunction gcmEncryptFN(size) {\n  function commonChecks(key, iv) {\n    if (size !== key.length << 3) {\n      throw new Error(\"invalid key size\");\n    }\n\n    if (12 !== iv.length) {\n      throw new Error(\"invalid iv\");\n    }\n  } // ### 'fallback' implementation -- uses forge\n\n\n  var fallback = function (key, pdata, props) {\n    var iv = props.iv || new Buffer(0),\n        adata = props.aad || props.adata || new Buffer(0),\n        cipher,\n        cdata; // validate inputs\n\n    try {\n      commonChecks(key, iv, adata);\n    } catch (err) {\n      return Promise.reject(err);\n    } // setup cipher\n\n\n    cipher = GCM.createCipher({\n      key: key,\n      iv: iv,\n      additionalData: adata\n    }); // ciphertext is the same length as plaintext\n\n    cdata = new Buffer(pdata.length);\n    var promise = new Promise(function (resolve, reject) {\n      var amt = CONSTANTS.CHUNK_SIZE,\n          clen = 0,\n          poff = 0;\n\n      (function doChunk() {\n        var plen = Math.min(amt, pdata.length - poff);\n        clen += cipher.update(pdata, poff, plen, cdata, clen);\n        poff += plen;\n\n        if (pdata.length > poff) {\n          setTimeout(doChunk, 0);\n          return;\n        } // finish it\n\n\n        clen += cipher.finish(cdata, clen);\n\n        if (clen !== pdata.length) {\n          reject(new Error(\"encryption failed\"));\n          return;\n        } // resolve with output\n\n\n        var tag = cipher.tag;\n        resolve({\n          data: cdata,\n          tag: tag\n        });\n      })();\n    });\n    return promise;\n  }; // ### WebCryptoAPI implementation\n  // TODO: cache CryptoKey sooner\n\n\n  var webcrypto = function (key, pdata, props) {\n    var iv = props.iv || new Buffer(0),\n        adata = props.aad || props.adata || new Buffer(0);\n\n    try {\n      commonChecks(key, iv, adata);\n    } catch (err) {\n      return Promise.reject(err);\n    }\n\n    var alg = {\n      name: \"AES-GCM\"\n    };\n    var promise;\n    promise = helpers.subtleCrypto.importKey(\"raw\", key, alg, true, [\"encrypt\"]);\n    promise = promise.then(function (key) {\n      alg.iv = iv;\n      alg.tagLength = 128;\n\n      if (adata.length) {\n        alg.additionalData = adata;\n      }\n\n      return helpers.subtleCrypto.encrypt(alg, key, pdata);\n    });\n    promise = promise.then(function (result) {\n      var tagStart = result.byteLength - 16;\n      var tag = result.slice(tagStart);\n      tag = new Buffer(tag);\n      var cdata = result.slice(0, tagStart);\n      cdata = new Buffer(cdata);\n      return {\n        data: cdata,\n        tag: tag\n      };\n    });\n    return promise;\n  }; // ### NodeJS implementation\n\n\n  var nodejs = function (key, pdata, props) {\n    var iv = props.iv || new Buffer(0),\n        adata = props.aad || props.adata || new Buffer(0);\n\n    try {\n      commonChecks(key, iv, adata);\n    } catch (err) {\n      return Promise.reject(err);\n    }\n\n    var alg = \"aes-\" + key.length * 8 + \"-gcm\";\n    var cipher;\n\n    try {\n      cipher = helpers.nodeCrypto.createCipheriv(alg, key, iv);\n    } catch (err) {\n      throw new Error(\"unsupported algorithm: \" + alg);\n    }\n\n    if (\"function\" !== typeof cipher.setAAD) {\n      throw new Error(\"unsupported algorithm: \" + alg);\n    }\n\n    if (adata.length) {\n      cipher.setAAD(adata);\n    }\n\n    var cdata = Buffer.concat([cipher.update(pdata), cipher.final()]);\n    var tag = cipher.getAuthTag();\n    return {\n      data: cdata,\n      tag: tag\n    };\n  };\n\n  return helpers.setupFallback(nodejs, webcrypto, fallback);\n}\n\nfunction gcmDecryptFN(size) {\n  function commonChecks(key, iv, tag) {\n    if (size !== key.length << 3) {\n      throw new Error(\"invalid key size\");\n    }\n\n    if (12 !== iv.length) {\n      throw new Error(\"invalid iv\");\n    }\n\n    if (16 !== tag.length) {\n      throw new Error(\"invalid tag length\");\n    }\n  } // ### fallback implementation -- uses forge\n\n\n  var fallback = function (key, cdata, props) {\n    var adata = props.aad || props.adata || new Buffer(0),\n        iv = props.iv || new Buffer(0),\n        tag = props.tag || props.mac || new Buffer(0),\n        cipher,\n        pdata; // validate inputs\n\n    try {\n      commonChecks(key, iv, tag);\n    } catch (err) {\n      return Promise.reject(err);\n    } // setup cipher\n\n\n    cipher = GCM.createDecipher({\n      key: key,\n      iv: iv,\n      additionalData: adata,\n      tag: tag\n    }); // plaintext is the same length as ciphertext\n\n    pdata = new Buffer(cdata.length);\n    var promise = new Promise(function (resolve, reject) {\n      var amt = CONSTANTS.CHUNK_SIZE,\n          plen = 0,\n          coff = 0;\n\n      (function doChunk() {\n        var clen = Math.min(amt, cdata.length - coff);\n        plen += cipher.update(cdata, coff, clen, pdata, plen);\n        coff += clen;\n\n        if (cdata.length > coff) {\n          setTimeout(doChunk, 0);\n          return;\n        }\n\n        try {\n          plen += cipher.finish(pdata, plen);\n        } catch (err) {\n          reject(new Error(\"decryption failed\"));\n          return;\n        }\n\n        if (plen !== cdata.length) {\n          reject(new Error(\"decryption failed\"));\n          return;\n        } // resolve with output\n\n\n        resolve(pdata);\n      })();\n    });\n    return promise;\n  }; // ### WebCryptoAPI implementation\n  // TODO: cache CryptoKey sooner\n\n\n  var webcrypto = function (key, cdata, props) {\n    var adata = props.aad || props.adata || new Buffer(0),\n        iv = props.iv || new Buffer(0),\n        tag = props.tag || props.mac || new Buffer(0); // validate inputs\n\n    try {\n      commonChecks(key, iv, tag);\n    } catch (err) {\n      return Promise.reject(err);\n    }\n\n    var alg = {\n      name: \"AES-GCM\"\n    };\n    var promise;\n    promise = helpers.subtleCrypto.importKey(\"raw\", key, alg, true, [\"decrypt\"]);\n    promise = promise.then(function (key) {\n      alg.iv = iv;\n      alg.tagLength = 128;\n\n      if (adata.length) {\n        alg.additionalData = adata;\n      } // concatenate cdata and tag\n\n\n      cdata = Buffer.concat([cdata, tag], cdata.length + tag.length);\n      return helpers.subtleCrypto.decrypt(alg, key, cdata);\n    });\n    promise = promise.then(function (pdata) {\n      pdata = new Buffer(pdata);\n      return pdata;\n    });\n    return promise;\n  };\n\n  var nodejs = function (key, cdata, props) {\n    var adata = props.aad || props.adata || new Buffer(0),\n        iv = props.iv || new Buffer(0),\n        tag = props.tag || props.mac || new Buffer(0); // validate inputs\n\n    try {\n      commonChecks(key, iv, tag);\n    } catch (err) {\n      return Promise.reject(err);\n    }\n\n    var alg = \"aes-\" + key.length * 8 + \"-gcm\";\n    var cipher;\n\n    try {\n      cipher = helpers.nodeCrypto.createDecipheriv(alg, key, iv);\n    } catch (err) {\n      throw new Error(\"unsupported algorithm: \" + alg);\n    }\n\n    if (\"function\" !== typeof cipher.setAAD) {\n      throw new Error(\"unsupported algorithm: \" + alg);\n    }\n\n    cipher.setAuthTag(tag);\n\n    if (adata.length) {\n      cipher.setAAD(adata);\n    }\n\n    try {\n      var pdata = Buffer.concat([cipher.update(cdata), cipher.final()]);\n      return pdata;\n    } catch (err) {\n      throw new Error(\"decryption failed\");\n    }\n  };\n\n  return helpers.setupFallback(nodejs, webcrypto, fallback);\n} // ### Public API\n// * [name].encrypt\n// * [name].decrypt\n\n\nvar aesGcm = {};\n[\"A128GCM\", \"A192GCM\", \"A256GCM\", \"A128GCMKW\", \"A192GCMKW\", \"A256GCMKW\"].forEach(function (alg) {\n  var size = parseInt(/A(\\d+)GCM(?:KW)?/g.exec(alg)[1]);\n  aesGcm[alg] = {\n    encrypt: gcmEncryptFN(size),\n    decrypt: gcmDecryptFN(size)\n  };\n});\nmodule.exports = aesGcm;","map":{"version":3,"sources":["/Users/pratison/Work/Cisco/Education/React/education-webex/node_modules/node-jose/lib/algorithms/aes-gcm.js"],"names":["helpers","require","CONSTANTS","GCM","gcmEncryptFN","size","commonChecks","key","iv","length","Error","fallback","pdata","props","Buffer","adata","aad","cipher","cdata","err","Promise","reject","createCipher","additionalData","promise","resolve","amt","CHUNK_SIZE","clen","poff","doChunk","plen","Math","min","update","setTimeout","finish","tag","data","webcrypto","alg","name","subtleCrypto","importKey","then","tagLength","encrypt","result","tagStart","byteLength","slice","nodejs","nodeCrypto","createCipheriv","setAAD","concat","final","getAuthTag","setupFallback","gcmDecryptFN","mac","createDecipher","coff","decrypt","createDecipheriv","setAuthTag","aesGcm","forEach","parseInt","exec","module","exports"],"mappings":"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","sourcesContent":["/*!\n * algorithms/aes-gcm.js - AES-GCM Encryption and Key-Wrapping\n *\n * Copyright (c) 2015 Cisco Systems, Inc.  See LICENSE file.\n */\n\"use strict\";\n\nvar helpers = require(\"./helpers.js\"),\n    CONSTANTS = require(\"./constants.js\"),\n    GCM = require(\"../deps/ciphermodes/gcm\");\n\nfunction gcmEncryptFN(size) {\n  function commonChecks(key, iv) {\n    if (size !== (key.length << 3)) {\n       throw new Error(\"invalid key size\");\n    }\n    if (12 !== iv.length) {\n      throw new Error(\"invalid iv\");\n    }\n  }\n\n  // ### 'fallback' implementation -- uses forge\n  var fallback = function(key, pdata, props) {\n    var iv = props.iv || new Buffer(0),\n        adata = props.aad || props.adata || new Buffer(0),\n        cipher,\n        cdata;\n\n    // validate inputs\n    try {\n      commonChecks(key, iv, adata);\n    } catch (err) {\n      return Promise.reject(err);\n    }\n\n    // setup cipher\n    cipher = GCM.createCipher({\n      key: key,\n      iv: iv,\n      additionalData: adata\n    });\n    // ciphertext is the same length as plaintext\n    cdata = new Buffer(pdata.length);\n\n    var promise = new Promise(function(resolve, reject) {\n      var amt = CONSTANTS.CHUNK_SIZE,\n          clen = 0,\n          poff = 0;\n\n      (function doChunk() {\n        var plen = Math.min(amt, pdata.length - poff);\n        clen += cipher.update(pdata,\n                              poff,\n                              plen,\n                              cdata,\n                              clen);\n        poff += plen;\n        if (pdata.length > poff) {\n          setTimeout(doChunk, 0);\n          return;\n        }\n\n        // finish it\n        clen += cipher.finish(cdata, clen);\n        if (clen !== pdata.length) {\n          reject(new Error(\"encryption failed\"));\n          return;\n        }\n\n        // resolve with output\n        var tag = cipher.tag;\n        resolve({\n          data: cdata,\n          tag: tag\n        });\n      })();\n    });\n\n    return promise;\n  };\n\n  // ### WebCryptoAPI implementation\n  // TODO: cache CryptoKey sooner\n  var webcrypto = function(key, pdata, props) {\n    var iv = props.iv || new Buffer(0),\n        adata = props.aad || props.adata || new Buffer(0);\n\n    try {\n      commonChecks(key, iv, adata);\n    } catch (err) {\n      return Promise.reject(err);\n    }\n\n    var alg = {\n      name: \"AES-GCM\"\n    };\n    var promise;\n    promise = helpers.subtleCrypto.importKey(\"raw\", key, alg, true, [\"encrypt\"]);\n    promise = promise.then(function(key) {\n      alg.iv = iv;\n      alg.tagLength = 128;\n      if (adata.length) {\n        alg.additionalData = adata;\n      }\n\n      return helpers.subtleCrypto.encrypt(alg, key, pdata);\n    });\n    promise = promise.then(function(result) {\n      var tagStart = result.byteLength - 16;\n\n      var tag = result.slice(tagStart);\n      tag = new Buffer(tag);\n\n      var cdata = result.slice(0, tagStart);\n      cdata = new Buffer(cdata);\n\n      return {\n        data: cdata,\n        tag: tag\n      };\n    });\n\n    return promise;\n  };\n\n  // ### NodeJS implementation\n  var nodejs = function(key, pdata, props) {\n    var iv = props.iv || new Buffer(0),\n        adata = props.aad || props.adata || new Buffer(0);\n\n    try {\n      commonChecks(key, iv, adata);\n    } catch (err) {\n      return Promise.reject(err);\n    }\n\n    var alg = \"aes-\" + (key.length * 8) + \"-gcm\";\n    var cipher;\n    try {\n      cipher = helpers.nodeCrypto.createCipheriv(alg, key, iv);\n    } catch (err) {\n      throw new Error(\"unsupported algorithm: \" + alg);\n    }\n    if (\"function\" !== typeof cipher.setAAD) {\n      throw new Error(\"unsupported algorithm: \" + alg);\n    }\n    if (adata.length) {\n      cipher.setAAD(adata);\n    }\n\n    var cdata = Buffer.concat([\n      cipher.update(pdata),\n      cipher.final()\n    ]);\n    var tag = cipher.getAuthTag();\n\n    return {\n      data: cdata,\n      tag: tag\n    };\n  };\n\n  return helpers.setupFallback(nodejs, webcrypto, fallback);\n}\nfunction gcmDecryptFN(size) {\n  function commonChecks(key, iv, tag) {\n    if (size !== (key.length << 3)) {\n      throw new Error(\"invalid key size\");\n    }\n    if (12 !== iv.length) {\n      throw new Error(\"invalid iv\");\n    }\n    if (16 !== tag.length) {\n      throw new Error(\"invalid tag length\");\n    }\n  }\n\n  // ### fallback implementation -- uses forge\n  var fallback = function(key, cdata, props) {\n    var adata = props.aad || props.adata || new Buffer(0),\n        iv = props.iv || new Buffer(0),\n        tag = props.tag || props.mac || new Buffer(0),\n        cipher,\n        pdata;\n\n    // validate inputs\n    try {\n      commonChecks(key, iv, tag);\n    } catch (err) {\n      return Promise.reject(err);\n    }\n\n    // setup cipher\n    cipher = GCM.createDecipher({\n      key: key,\n      iv: iv,\n      additionalData: adata,\n      tag: tag\n    });\n    // plaintext is the same length as ciphertext\n    pdata = new Buffer(cdata.length);\n\n    var promise = new Promise(function(resolve, reject) {\n      var amt = CONSTANTS.CHUNK_SIZE,\n          plen = 0,\n          coff = 0;\n\n      (function doChunk() {\n        var clen = Math.min(amt, cdata.length - coff);\n        plen += cipher.update(cdata,\n                              coff,\n                              clen,\n                              pdata,\n                              plen);\n        coff += clen;\n        if (cdata.length > coff) {\n          setTimeout(doChunk, 0);\n          return;\n        }\n\n        try {\n          plen += cipher.finish(pdata, plen);\n        } catch (err) {\n          reject(new Error(\"decryption failed\"));\n          return;\n        }\n\n        if (plen !== cdata.length) {\n          reject(new Error(\"decryption failed\"));\n          return;\n        }\n\n        // resolve with output\n        resolve(pdata);\n      })();\n    });\n\n    return promise;\n  };\n\n  // ### WebCryptoAPI implementation\n  // TODO: cache CryptoKey sooner\n  var webcrypto = function(key, cdata, props) {\n    var adata = props.aad || props.adata || new Buffer(0),\n        iv = props.iv || new Buffer(0),\n        tag = props.tag || props.mac || new Buffer(0);\n\n    // validate inputs\n    try {\n      commonChecks(key, iv, tag);\n    } catch (err) {\n      return Promise.reject(err);\n    }\n\n    var alg = {\n      name: \"AES-GCM\"\n    };\n    var promise;\n    promise = helpers.subtleCrypto.importKey(\"raw\", key, alg, true, [\"decrypt\"]);\n    promise = promise.then(function(key) {\n      alg.iv = iv;\n      alg.tagLength = 128;\n      if (adata.length) {\n        alg.additionalData = adata;\n      }\n\n      // concatenate cdata and tag\n      cdata = Buffer.concat([cdata, tag], cdata.length + tag.length);\n\n      return helpers.subtleCrypto.decrypt(alg, key, cdata);\n    });\n    promise = promise.then(function(pdata) {\n      pdata = new Buffer(pdata);\n      return pdata;\n    });\n\n    return promise;\n  };\n\n  var nodejs = function(key, cdata, props) {\n    var adata = props.aad || props.adata || new Buffer(0),\n        iv = props.iv || new Buffer(0),\n        tag = props.tag || props.mac || new Buffer(0);\n\n    // validate inputs\n    try {\n      commonChecks(key, iv, tag);\n    } catch (err) {\n      return Promise.reject(err);\n    }\n\n    var alg = \"aes-\" + (key.length * 8) + \"-gcm\";\n    var cipher;\n    try {\n      cipher = helpers.nodeCrypto.createDecipheriv(alg, key, iv);\n    } catch(err) {\n      throw new Error(\"unsupported algorithm: \" + alg);\n    }\n    if (\"function\" !== typeof cipher.setAAD) {\n      throw new Error(\"unsupported algorithm: \" + alg);\n    }\n    cipher.setAuthTag(tag);\n    if (adata.length) {\n      cipher.setAAD(adata);\n    }\n\n    try {\n      var pdata = Buffer.concat([\n        cipher.update(cdata),\n        cipher.final()\n      ]);\n\n      return pdata;\n    } catch (err) {\n      throw new Error(\"decryption failed\");\n    }\n  };\n\n  return helpers.setupFallback(nodejs, webcrypto, fallback);\n}\n\n// ### Public API\n// * [name].encrypt\n// * [name].decrypt\nvar aesGcm = {};\n[\n  \"A128GCM\",\n  \"A192GCM\",\n  \"A256GCM\",\n  \"A128GCMKW\",\n  \"A192GCMKW\",\n  \"A256GCMKW\"\n].forEach(function(alg) {\n  var size = parseInt(/A(\\d+)GCM(?:KW)?/g.exec(alg)[1]);\n  aesGcm[alg] = {\n    encrypt: gcmEncryptFN(size),\n    decrypt: gcmDecryptFN(size)\n  };\n});\n\nmodule.exports = aesGcm;\n"]},"metadata":{},"sourceType":"script"}