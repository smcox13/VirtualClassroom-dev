{"ast":null,"code":"/**!\n * lib/index.js -- SCR Implementation\n *\n * Copyright (c) 2015 Cisco Systems, Inc. See LICENSE file.\n */\n\"use strict\";\n\nvar clone = require(\"lodash.clone\"),\n    jose = require(\"node-jose\");\n\nfunction SCRObject(cfg) {\n  cfg.loc = cfg.loc || undefined;\n  cfg.tag = cfg.tag || undefined;\n  Object.defineProperty(this, \"enc\", {\n    get: function () {\n      return cfg.enc;\n    },\n    enumerable: true\n  });\n  Object.defineProperty(this, \"key\", {\n    get: function () {\n      return cfg.key;\n    },\n    enumerable: true\n  });\n  Object.defineProperty(this, \"iv\", {\n    get: function () {\n      return cfg.iv;\n    },\n    enumerable: true\n  });\n  Object.defineProperty(this, \"aad\", {\n    get: function () {\n      return cfg.aad;\n    },\n    enumerable: true\n  });\n  Object.defineProperty(this, \"loc\", {\n    get: function () {\n      return cfg.loc;\n    },\n    set: function (loc) {\n      cfg.loc = loc;\n    },\n    enumerable: true\n  });\n  Object.defineProperty(this, \"tag\", {\n    get: function () {\n      return cfg.tag;\n    },\n    enumerable: true\n  });\n  Object.defineProperty(this, \"toJSON\", {\n    value: function () {\n      var key = cfg.key.get(\"k\", true);\n      var data = {};\n      data.enc = cfg.enc;\n      data.key = jose.util.base64url.encode(key);\n      data.iv = jose.util.base64url.encode(cfg.iv);\n      data.aad = cfg.aad;\n\n      if (cfg.loc) {\n        data.loc = cfg.loc;\n      }\n\n      if (cfg.tag) {\n        data.tag = jose.util.base64url.encode(cfg.tag);\n      }\n\n      return data;\n    }\n  });\n  Object.defineProperty(this, \"toJWE\", {\n    value: function (jwk) {\n      var self = this,\n          promise;\n      promise = jose.JWK.asKey(jwk);\n      promise = promise.then(function (jwk) {\n        var rcpt = {\n          header: {\n            alg: \"dir\"\n          },\n          key: jwk,\n          reference: false\n        };\n        var opts = {\n          compact: true,\n          contentAlg: cfg.enc\n        };\n        var data = self.toJSON();\n        data = JSON.stringify(data);\n        return jose.JWE.createEncrypt(opts, rcpt).final(data, \"utf8\");\n      });\n      return promise;\n    }\n  });\n  Object.defineProperty(this, \"encrypt\", {\n    value: function (pdata) {\n      var props = {\n        iv: cfg.iv,\n        adata: new Buffer(cfg.aad, \"utf8\")\n      }; // condition the data before encrypting\n\n      pdata = jose.util.asBuffer(pdata);\n      return cfg.key.encrypt(cfg.enc, pdata, props).then(function (result) {\n        var cdata = result.data;\n        cfg.tag = result.tag;\n        return cdata;\n      });\n    }\n  });\n  Object.defineProperty(this, \"decrypt\", {\n    value: function (cdata) {\n      var props = {\n        iv: cfg.iv,\n        adata: new Buffer(cfg.aad, \"utf8\"),\n        mac: cfg.tag\n      }; // condition data before decrypting\n\n      cdata = jose.util.asBuffer(cdata);\n      return cfg.key.decrypt(cfg.enc, cdata, props).then(function (pdata) {\n        return pdata;\n      });\n    }\n  });\n}\n\nvar SCR = {\n  create: function () {\n    // TODO: make this more configurable\n    // TODO: abstract away forge??\n    var iv = jose.util.randomBytes(12);\n    var aad = new Date().toISOString();\n    var keystore = jose.JWK.createKeyStore();\n    var promise = keystore.generate(\"oct\", 256);\n    promise = promise.then(function (key) {\n      return new SCRObject({\n        enc: \"A256GCM\",\n        key: key,\n        iv: iv,\n        aad: aad\n      });\n    });\n    return promise;\n  },\n  fromJWE: function (jwk, jwe) {\n    var promise;\n    promise = jose.JWK.asKey(jwk);\n    promise = promise.then(function (jwk) {\n      return jose.JWE.createDecrypt(jwk).decrypt(jwe);\n    });\n    promise = promise.then(function (result) {\n      result = result.plaintext.toString(\"utf8\");\n      result = JSON.parse(result);\n      return SCR.fromJSON(result);\n    });\n    return promise;\n  },\n  fromJSON: function (json) {\n    // create a copy to mitigate tampering\n    var cfg = clone(json);\n    var promise;\n\n    if (json.key) {\n      promise = jose.JWK.asKey({\n        kty: \"oct\",\n        k: json.key\n      });\n    } else {\n      promise = Promise.resolve();\n    }\n\n    promise = promise.then(function (key) {\n      if (key) {\n        cfg.key = key;\n      }\n\n      if (\"iv\" in cfg) {\n        cfg.iv = Buffer.isBuffer(cfg.iv) ? cfg.iv : jose.util.base64url.decode(cfg.iv);\n      }\n\n      if (\"tag\" in cfg) {\n        cfg.tag = Buffer.isBuffer(cfg.tag) ? cfg.tag : jose.util.base64url.decode(cfg.tag);\n      }\n\n      return new SCRObject(cfg);\n    });\n    return promise;\n  }\n};\nmodule.exports = SCR;","map":{"version":3,"sources":["/Users/pratison/Work/Cisco/Education/React/education-webex/node_modules/node-scr/lib/index.js"],"names":["clone","require","jose","SCRObject","cfg","loc","undefined","tag","Object","defineProperty","get","enc","enumerable","key","iv","aad","set","value","data","util","base64url","encode","jwk","self","promise","JWK","asKey","then","rcpt","header","alg","reference","opts","compact","contentAlg","toJSON","JSON","stringify","JWE","createEncrypt","final","pdata","props","adata","Buffer","asBuffer","encrypt","result","cdata","mac","decrypt","SCR","create","randomBytes","Date","toISOString","keystore","createKeyStore","generate","fromJWE","jwe","createDecrypt","plaintext","toString","parse","fromJSON","json","kty","k","Promise","resolve","isBuffer","decode","module","exports"],"mappings":"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","sourcesContent":["/**!\n * lib/index.js -- SCR Implementation\n *\n * Copyright (c) 2015 Cisco Systems, Inc. See LICENSE file.\n */\n \"use strict\";\n\nvar clone = require(\"lodash.clone\"),\n    jose = require(\"node-jose\");\n\nfunction SCRObject(cfg) {\n  cfg.loc = cfg.loc || undefined;\n  cfg.tag = cfg.tag || undefined;\n\n  Object.defineProperty(this, \"enc\", {\n    get: function() {\n      return cfg.enc;\n    },\n    enumerable: true\n  });\n  Object.defineProperty(this, \"key\", {\n    get: function() {\n      return cfg.key;\n    },\n    enumerable: true\n  });\n  Object.defineProperty(this, \"iv\", {\n    get: function() {\n      return cfg.iv;\n    },\n    enumerable: true\n  });\n  Object.defineProperty(this, \"aad\", {\n    get: function() {\n      return cfg.aad;\n    },\n    enumerable: true\n  });\n  Object.defineProperty(this, \"loc\", {\n    get: function() {\n      return cfg.loc;\n    },\n    set: function(loc) {\n      cfg.loc = loc;\n    },\n    enumerable: true\n  });\n  Object.defineProperty(this, \"tag\", {\n    get: function() {\n      return cfg.tag;\n    },\n    enumerable: true\n  });\n\n  Object.defineProperty(this, \"toJSON\", {\n    value: function() {\n      var key = cfg.key.get(\"k\", true);\n      var data = {};\n      data.enc = cfg.enc;\n      data.key = jose.util.base64url.encode(key);\n      data.iv = jose.util.base64url.encode(cfg.iv);\n      data.aad = cfg.aad;\n\n      if (cfg.loc) {\n        data.loc = cfg.loc;\n      }\n      if (cfg.tag) {\n        data.tag = jose.util.base64url.encode(cfg.tag);\n      }\n\n      return data;\n    }\n  });\n  Object.defineProperty(this, \"toJWE\", {\n    value: function(jwk) {\n      var self = this,\n          promise;\n      promise = jose.JWK.asKey(jwk);\n      promise = promise.then(function(jwk) {\n        var rcpt = {\n          header: {\n            alg: \"dir\"\n          },\n          key: jwk,\n          reference: false\n        };\n        var opts = {\n          compact: true,\n          contentAlg: cfg.enc\n        };\n\n        var data = self.toJSON();\n        data = JSON.stringify(data);\n        return jose.JWE.createEncrypt(opts, rcpt).\n               final(data, \"utf8\");\n      });\n\n      return promise;\n    }\n  });\n\n  Object.defineProperty(this, \"encrypt\", {\n    value: function(pdata) {\n      var props = {\n        iv: cfg.iv,\n        adata: new Buffer(cfg.aad, \"utf8\")\n      };\n\n      // condition the data before encrypting\n      pdata = jose.util.asBuffer(pdata);\n      return cfg.key.encrypt(cfg.enc, pdata, props).\n             then(function(result) {\n                var cdata = result.data;\n                cfg.tag = result.tag;\n\n                return cdata;\n             });\n    }\n  });\n  Object.defineProperty(this, \"decrypt\", {\n    value: function(cdata) {\n        var props = {\n          iv: cfg.iv,\n          adata: new Buffer(cfg.aad, \"utf8\"),\n          mac: cfg.tag\n        };\n\n        // condition data before decrypting\n        cdata = jose.util.asBuffer(cdata);\n        return cfg.key.decrypt(cfg.enc, cdata, props).\n               then(function(pdata) {\n                  return pdata;\n               });\n    }\n  });\n}\n\nvar SCR = {\n  create: function() {\n    // TODO: make this more configurable\n    // TODO: abstract away forge??\n    var iv = jose.util.randomBytes(12);\n    var aad = new Date().toISOString();\n\n    var keystore = jose.JWK.createKeyStore();\n    var promise = keystore.generate(\"oct\", 256);\n    promise = promise.then(function(key) {\n      return new SCRObject({\n        enc: \"A256GCM\",\n        key: key,\n        iv: iv,\n        aad: aad\n      });\n    });\n\n    return promise;\n  },\n  fromJWE: function(jwk, jwe) {\n    var promise;\n    promise = jose.JWK.asKey(jwk);\n    promise = promise.then(function(jwk) {\n      return jose.JWE.createDecrypt(jwk).decrypt(jwe);\n    });\n    promise = promise.then(function(result) {\n      result = result.plaintext.toString(\"utf8\");\n      result = JSON.parse(result);\n      return SCR.fromJSON(result);\n    });\n\n    return promise;\n  },\n  fromJSON: function(json) {\n    // create a copy to mitigate tampering\n    var cfg = clone(json);\n\n    var promise;\n    if (json.key) {\n      promise = jose.JWK.asKey({\n        kty: \"oct\",\n        k: json.key\n      });\n    } else {\n      promise = Promise.resolve();\n    }\n    promise = promise.then(function(key) {\n      if (key) {\n        cfg.key = key;\n      }\n\n      if (\"iv\" in cfg) {\n        cfg.iv = Buffer.isBuffer(cfg.iv) ?\n                 cfg.iv :\n                 jose.util.base64url.decode(cfg.iv);\n      }\n      if (\"tag\" in cfg) {\n        cfg.tag = Buffer.isBuffer(cfg.tag) ?\n                  cfg.tag :\n                  jose.util.base64url.decode(cfg.tag);\n      }\n\n      return new SCRObject(cfg);\n    });\n\n    return promise;\n  }\n};\n\nmodule.exports = SCR;\n"]},"metadata":{},"sourceType":"script"}